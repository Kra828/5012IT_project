{% extends 'base.html' %}

{% block title %}仪表盘 - 在线学习平台{% endblock %}

{% block content %}
    <div class="container py-5">
        <div class="row mb-4">
            <div class="col-md-8">
                <h1>欢迎回来，{{ user.first_name|default:user.username }}</h1>
                <p class="lead">这是您的个人学习仪表盘，您可以在这里管理您的学习进度。</p>
            </div>
            <div class="col-md-4 text-end">
                {% if user.is_teacher %}
                    <a href="{% url 'courses:teacher_course_list' %}" class="btn btn-primary">
                        <i class="fas fa-plus-circle"></i> 管理我的课程
                    </a>
                {% endif %}
            </div>
        </div>

        <div class="row">
            <!-- 左侧边栏 -->
            <div class="col-md-3">
                <div class="card mb-4">
                    <div class="card-body text-center">
                        {% if user.profile_picture %}
                            <img src="{{ user.profile_picture.url }}" alt="{{ user.username }}" 
                                 class="rounded-circle img-fluid mb-3" style="max-width: 150px;">
                        {% else %}
                            <div class="display-1 text-muted mb-3">
                                <i class="fas fa-user-circle"></i>
                            </div>
                        {% endif %}
                        <h5>{{ user.get_full_name|default:user.username }}</h5>
                        <p class="text-muted">
                            {% if user.is_teacher %}教师{% else %}学生{% endif %}
                        </p>
                        <a href="{% url 'accounts:profile' %}" class="btn btn-sm btn-outline-primary">
                            编辑个人资料
                        </a>
                    </div>
                </div>

                <div class="list-group mb-4">
                    <a href="#" class="list-group-item list-group-item-action active">
                        <i class="fas fa-tachometer-alt me-2"></i> 仪表盘
                    </a>
                    <a href="{% url 'courses:course_list' %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-book me-2"></i> 所有课程
                    </a>
                    {% if user.is_student %}
                        <a href="#enrolled-courses" class="list-group-item list-group-item-action">
                            <i class="fas fa-graduation-cap me-2"></i> 我的课程
                        </a>
                    {% endif %}
                    <a href="{% url 'forum:board_list' %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-comments me-2"></i> 讨论区
                    </a>
                    <a href="{% url 'ai_assistant:home' %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-robot me-2"></i> AI助手
                    </a>
                </div>
            </div>

            <!-- 主要内容 -->
            <div class="col-md-9">
                {% if user.is_student %}
                    <!-- 学生仪表盘 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">学习进度概览</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <div class="display-4">{{ enrolled_courses|default:"0" }}</div>
                                    <p>已注册课程</p>
                                </div>
                                <div class="col-md-4">
                                    <div class="display-4">{{ completed_lessons|default:"0" }}</div>
                                    <p>已完成课程</p>
                                </div>
                                <div class="col-md-4">
                                    <div class="display-4">{{ quiz_attempts|default:"0" }}</div>
                                    <p>测验尝试</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 已注册课程 -->
                    <div class="card mb-4" id="enrolled-courses">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">我的课程</h5>
                            <a href="{% url 'courses:course_list' %}" class="btn btn-sm btn-outline-primary">
                                浏览更多课程
                            </a>
                        </div>
                        <div class="card-body">
                            {% if enrolled_courses %}
                                <div class="row">
                                    {% for enrollment in enrolled_courses %}
                                        <div class="col-md-6 mb-3">
                                            <div class="card h-100">
                                                {% if enrollment.course.thumbnail %}
                                                    <img src="{{ enrollment.course.thumbnail.url }}" class="card-img-top" alt="{{ enrollment.course.title }}">
                                                {% else %}
                                                    <div class="bg-light text-center py-5">
                                                        <i class="fas fa-book fa-3x text-muted"></i>
                                                    </div>
                                                {% endif %}
                                                <div class="card-body">
                                                    <h5 class="card-title">{{ enrollment.course.title }}</h5>
                                                    <p class="card-text small text-muted">
                                                        讲师: {{ enrollment.course.instructor.get_full_name|default:enrollment.course.instructor.username }}
                                                    </p>
                                                    <div class="progress mb-2">
                                                        <div class="progress-bar" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">25%</div>
                                                    </div>
                                                    <a href="{% url 'courses:course_detail' enrollment.course.slug %}" class="btn btn-sm btn-primary">
                                                        继续学习
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <div class="display-1 text-muted mb-3">
                                        <i class="fas fa-book"></i>
                                    </div>
                                    <h4>您还没有注册任何课程</h4>
                                    <p>浏览我们的课程目录，开始您的学习之旅。</p>
                                    <a href="{% url 'courses:course_list' %}" class="btn btn-primary">
                                        浏览课程
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- 学习建议 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">学习建议</h5>
                        </div>
                        <div class="card-body">
                            {% if recommendations %}
                                <div class="list-group">
                                    {% for recommendation in recommendations %}
                                        <a href="{% url 'ai_assistant:recommendation_detail' recommendation.id %}" class="list-group-item list-group-item-action">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h5 class="mb-1">{{ recommendation.title }}</h5>
                                                <small>{{ recommendation.created_at|date:"Y-m-d" }}</small>
                                            </div>
                                            <p class="mb-1">{{ recommendation.description|truncatechars:100 }}</p>
                                        </a>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <p>暂无学习建议。随着您的学习进度，AI助手将为您提供个性化的学习建议。</p>
                                    <a href="{% url 'ai_assistant:home' %}" class="btn btn-outline-primary">
                                        咨询AI助手
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% else %}
                    <!-- 教师仪表盘 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">教学概览</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <div class="display-4">{{ courses_taught|default:"0" }}</div>
                                    <p>已创建课程</p>
                                </div>
                                <div class="col-md-4">
                                    <div class="display-4">{{ total_students|default:"0" }}</div>
                                    <p>学生总数</p>
                                </div>
                                <div class="col-md-4">
                                    <div class="display-4">{{ pending_submissions|default:"0" }}</div>
                                    <p>待批改作业</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 我的课程 -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">我的课程</h5>
                            <a href="{% url 'courses:course_create' %}" class="btn btn-sm btn-primary">
                                <i class="fas fa-plus-circle"></i> 创建新课程
                            </a>
                        </div>
                        <div class="card-body">
                            {% if courses_taught %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>课程名称</th>
                                                <th>分类</th>
                                                <th>学生数</th>
                                                <th>状态</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for course in courses_taught %}
                                                <tr>
                                                    <td>
                                                        <a href="{% url 'courses:course_detail' course.slug %}">
                                                            {{ course.title }}
                                                        </a>
                                                    </td>
                                                    <td>{{ course.category.name }}</td>
                                                    <td>{{ course.students.count }}</td>
                                                    <td>
                                                        {% if course.is_published %}
                                                            <span class="badge bg-success">已发布</span>
                                                        {% else %}
                                                            <span class="badge bg-warning">草稿</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <a href="{% url 'courses:course_update' course.slug %}" class="btn btn-outline-primary">
                                                                <i class="fas fa-edit"></i>
                                                            </a>
                                                            <a href="{% url 'courses:chapter_list' course.slug %}" class="btn btn-outline-info">
                                                                <i class="fas fa-list"></i>
                                                            </a>
                                                        </div>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <div class="display-1 text-muted mb-3">
                                        <i class="fas fa-chalkboard-teacher"></i>
                                    </div>
                                    <h4>您还没有创建任何课程</h4>
                                    <p>创建您的第一个课程，开始您的教学之旅。</p>
                                    <a href="{% url 'courses:course_create' %}" class="btn btn-primary">
                                        创建课程
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- 待批改作业 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">待批改作业</h5>
                        </div>
                        <div class="card-body">
                            {% if pending_submissions %}
                                <div class="list-group">
                                    {% for submission in pending_submissions %}
                                        <a href="{% url 'quizzes:grade_submission' submission.assignment.id submission.id %}" class="list-group-item list-group-item-action">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h5 class="mb-1">{{ submission.assignment.title }}</h5>
                                                <small>{{ submission.submitted_at|date:"Y-m-d H:i" }}</small>
                                            </div>
                                            <p class="mb-1">学生: {{ submission.student.get_full_name|default:submission.student.username }}</p>
                                            <small>课程: {{ submission.assignment.course.title }}</small>
                                        </a>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <p>暂无待批改的作业。</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %} 