{% extends 'base.html' %}

{% block title %}Dashboard - Online Learning Platform{% endblock %}

{% block content %}
    <div class="container py-5">
        <div class="row mb-4">
            <div class="col-md-8">
                <h1>Welcome back, {{ user.first_name|default:user.username }}</h1>
                <p class="lead">This is your personal learning dashboard where you can manage your learning progress.</p>
            </div>
            <div class="col-md-4 text-end">
                {% if user.is_teacher %}
                    <!-- 移除管理我的课程按钮 -->
                {% endif %}
            </div>
        </div>

        <div class="row">
            <!-- Left Sidebar -->
            <div class="col-md-3">
                <div class="card mb-4">
                    <div class="card-body text-center">
                        {% if user.profile_picture %}
                            <img src="{{ user.profile_picture.url }}" alt="{{ user.username }}" 
                                 class="rounded-circle img-fluid mb-3" style="max-width: 150px;">
                        {% else %}
                            <div class="display-1 text-muted mb-3">
                                <i class="fas fa-user-circle"></i>
                            </div>
                        {% endif %}
                        <h5>{{ user.get_full_name|default:user.username }}</h5>
                        <p class="text-muted">
                            {% if user.is_teacher %}Teacher{% else %}Student{% endif %}
                        </p>
                        <!-- 更改密码按钮 -->
                        <a href="{% url 'account_change_password' %}" class="btn btn-sm btn-outline-primary">
                            Change Password
                        </a>
                    </div>
                </div>

                <div class="list-group mb-4">
                    <a href="#" class="list-group-item list-group-item-action active">
                        <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                    </a>
                    <a href="{% url 'courses:course_list' %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-book me-2"></i> All Courses
                    </a>
                    {% if user.is_student %}
                        <!-- 移除我的课程链接 -->
                    {% endif %}
                    <a href="{% url 'forum:board_list' %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-comments me-2"></i> Discussion Forum
                    </a>
                    <a href="{% url 'ai_assistant:home' %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-robot me-2"></i> AI Assistant
                    </a>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9">
                {% if user.is_student %}
                    <!-- Student Dashboard -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Learning Progress Overview</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <div class="display-4">{{ enrolled_courses|default:"0" }}</div>
                                    <p>Enrolled Courses</p>
                                </div>
                                <div class="col-md-4">
                                    <div class="display-4">{{ completed_lessons|default:"0" }}</div>
                                    <p>Completed Lessons</p>
                                </div>
                                <div class="col-md-4">
                                    <div class="display-4">{{ quiz_attempts|default:"0" }}</div>
                                    <p>Quiz Attempts</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enrolled Courses -->
                    <div class="card mb-4" id="enrolled-courses">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">My Courses</h5>
                            <a href="{% url 'courses:course_list' %}" class="btn btn-sm btn-outline-primary">
                                Browse More Courses
                            </a>
                        </div>
                        <div class="card-body">
                            {% if enrolled_courses %}
                                <div class="row">
                                    {% for enrollment in enrolled_courses %}
                                        <div class="col-md-6 mb-3">
                                            <div class="card h-100">
                                                {% if enrollment.course.thumbnail %}
                                                    <img src="{{ enrollment.course.thumbnail.url }}" class="card-img-top" alt="{{ enrollment.course.title }}">
                                                {% else %}
                                                    <div class="bg-light text-center py-5">
                                                        <i class="fas fa-book fa-3x text-muted"></i>
                                                    </div>
                                                {% endif %}
                                                <div class="card-body">
                                                    <h5 class="card-title">{{ enrollment.course.title }}</h5>
                                                    <p class="card-text small text-muted">
                                                        Instructor: {{ enrollment.course.instructor.get_full_name|default:enrollment.course.instructor.username }}
                                                    </p>
                                                    <div class="progress mb-2">
                                                        <div class="progress-bar" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">25%</div>
                                                    </div>
                                                    <a href="{% url 'courses:course_detail' enrollment.course.slug %}" class="btn btn-sm btn-primary">
                                                        Continue Learning
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <div class="display-1 text-muted mb-3">
                                        <i class="fas fa-book"></i>
                                    </div>
                                    <h4>You haven't enrolled in any courses yet</h4>
                                    <p>Browse our course catalog to start your learning journey.</p>
                                    <a href="{% url 'courses:course_list' %}" class="btn btn-primary">
                                        Browse Courses
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Learning Recommendations -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Learning Recommendations</h5>
                        </div>
                        <div class="card-body">
                            {% if recommendations %}
                                <div class="list-group">
                                    {% for recommendation in recommendations %}
                                        <a href="{% url 'ai_assistant:recommendation_detail' recommendation.id %}" class="list-group-item list-group-item-action">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h5 class="mb-1">{{ recommendation.title }}</h5>
                                                <small>{{ recommendation.created_at|date:"Y-m-d" }}</small>
                                            </div>
                                            <p class="mb-1">{{ recommendation.description|truncatechars:100 }}</p>
                                        </a>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <p>No learning recommendations yet. As you progress with your learning, the AI assistant will provide personalized learning recommendations for you.</p>
                                    <a href="{% url 'ai_assistant:home' %}" class="btn btn-outline-primary">
                                        Consult AI Assistant
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% else %}
                    <!-- Teacher Dashboard -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Teaching Overview</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <div class="display-4">{{ courses_taught|default:"0" }}</div>
                                    <p>Created Courses</p>
                                </div>
                                <div class="col-md-4">
                                    <div class="display-4">{{ total_students|default:"0" }}</div>
                                    <p>Total Students</p>
                                </div>
                                <div class="col-md-4">
                                    <div class="display-4">{{ pending_submissions|default:"0" }}</div>
                                    <p>Pending Assignments</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- My Courses -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">My Courses</h5>
                            <a href="{% url 'courses:course_create' %}" class="btn btn-sm btn-primary">
                                <i class="fas fa-plus-circle"></i> Create New Course
                            </a>
                        </div>
                        <div class="card-body">
                            {% if courses_taught %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Course Name</th>
                                                <th>Category</th>
                                                <th>Students</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for course in courses_taught %}
                                                <tr>
                                                    <td>
                                                        <a href="{% url 'courses:course_detail' course.slug %}">
                                                            {{ course.title }}
                                                        </a>
                                                    </td>
                                                    <td>{{ course.category.name }}</td>
                                                    <td>{{ course.students.count }}</td>
                                                    <td>
                                                        {% if course.is_published %}
                                                            <span class="badge bg-success">Published</span>
                                                        {% else %}
                                                            <span class="badge bg-warning">Draft</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <a href="{% url 'courses:course_update' course.slug %}" class="btn btn-outline-primary">
                                                                <i class="fas fa-edit"></i>
                                                            </a>
                                                            <a href="{% url 'courses:chapter_list' course.slug %}" class="btn btn-outline-info">
                                                                <i class="fas fa-list"></i>
                                                            </a>
                                                        </div>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <div class="display-1 text-muted mb-3">
                                        <i class="fas fa-book"></i>
                                    </div>
                                    <h4>You haven't created any courses yet</h4>
                                    <p>Create your first course to start your teaching journey.</p>
                                    <a href="{% url 'courses:course_create' %}" class="btn btn-primary">
                                        Create Course
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %} 